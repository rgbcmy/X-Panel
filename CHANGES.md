# V2Board å¤š Inbound åŒæ­¥æ”¯æŒ - ä¿®æ”¹æ€»ç»“

## é—®é¢˜èƒŒæ™¯

åŸç³»ç»Ÿåœ¨ä» v2board åŒæ­¥å®¢æˆ·ç«¯ä¿¡æ¯æ—¶ï¼Œ`client_traffics` è¡¨çš„ `email` å­—æ®µè®¾ç½®äº†å…¨å±€å”¯ä¸€çº¦æŸï¼Œå¯¼è‡´åŒä¸€ä¸ªç”¨æˆ·æ— æ³•åŒæ­¥åˆ°å¤šä¸ª inboundï¼ˆä¸åŒèŠ‚ç‚¹ï¼‰ï¼Œå‡ºç° "Duplicate email" é”™è¯¯ã€‚

## è§£å†³æ–¹æ¡ˆ

å°† `email` çš„å”¯ä¸€çº¦æŸæ”¹ä¸º `(inbound_id, email)` çš„è”åˆå”¯ä¸€çº¦æŸï¼Œå…è®¸åŒä¸€ä¸ª email åœ¨ä¸åŒ inbound ä¸­å­˜åœ¨ã€‚

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. `xray/client_traffic.go`

**ä¿®æ”¹å†…å®¹ï¼š**
```go
// åŸæ¥
Email string `json:"email" form:"email" gorm:"unique"`

// ä¿®æ”¹å
InboundId int `json:"inboundId" form:"inboundId" gorm:"uniqueIndex:idx_inbound_email"`
Email     string `json:"email" form:"email" gorm:"uniqueIndex:idx_inbound_email"`
```

**ä½œç”¨ï¼š** å®šä¹‰è”åˆå”¯ä¸€ç´¢å¼•ï¼Œå…è®¸åŒä¸€ä¸ª email åœ¨ä¸åŒ inbound_id ä¸­å­˜åœ¨ã€‚

### 2. `database/db.go`

**æ–°å¢å†…å®¹ï¼š** æ·»åŠ  `migrateClientTrafficsTable()` å‡½æ•°

**ä½œç”¨ï¼š** 
- åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶æ‰§è¡Œæ•°æ®åº“è¿ç§»
- æ™ºèƒ½è·³è¿‡å·²è¿ç§»çš„æ•°æ®åº“
- è‡ªåŠ¨å¤‡ä»½åŸè¡¨æ•°æ®
- äº‹åŠ¡ä¿æŠ¤ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š

**ç‰¹ç‚¹ï¼š**
- âœ… é›¶é…ç½®ï¼Œè‡ªåŠ¨æ‰§è¡Œ
- âœ… å¹‚ç­‰æ€§ï¼Œå¯é‡å¤è¿è¡Œ
- âœ… å®‰å…¨å¤‡ä»½ï¼Œä¸ä¸¢æ•°æ®
- âœ… æ—¥å¿—å®Œæ•´ï¼Œä¾¿äºæ’æŸ¥

### 3. `web/service/inbound.go`

**ä¿®æ”¹çš„å‡½æ•°ï¼š**

#### `UpdateClientStat`
```go
// åŸæ¥
func (s *InboundService) UpdateClientStat(tx *gorm.DB, email string, client *model.Client)

// ä¿®æ”¹å
func (s *InboundService) UpdateClientStat(tx *gorm.DB, inboundId int, email string, client *model.Client)
```
- æ·»åŠ  `inboundId` å‚æ•°
- æŸ¥è¯¢æ¡ä»¶æ”¹ä¸º `WHERE inbound_id = ? AND email = ?`

#### `DelClientStat`
```go
// åŸæ¥
func (s *InboundService) DelClientStat(tx *gorm.DB, email string)

// ä¿®æ”¹å  
func (s *InboundService) DelClientStat(tx *gorm.DB, inboundId int, email string)
```
- æ·»åŠ  `inboundId` å‚æ•°
- åˆ é™¤æ¡ä»¶æ”¹ä¸º `WHERE inbound_id = ? AND email = ?`

#### æ›´æ–°æ‰€æœ‰è°ƒç”¨ç‚¹
- `DelInboundClient`: åœ¨æŸ¥è¯¢å’Œåˆ é™¤å®¢æˆ·ç«¯ç»Ÿè®¡æ—¶æ·»åŠ  `inboundId` å‚æ•°
- `updateClientTraffics`: åœ¨åˆ é™¤ä¸å­˜åœ¨çš„å®¢æˆ·ç«¯æ—¶æ·»åŠ  `inboundId` å‚æ•°
- å…¶ä»–è°ƒç”¨ `UpdateClientStat` å’Œ `DelClientStat` çš„åœ°æ–¹

### 4. æ–°å¢è¿ç§»æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

**æ³¨æ„ï¼š** ç”±äºè¿ç§»å·²é›†æˆåˆ° `database/db.go` ä¸­ï¼Œè¿™äº›æ–‡ä»¶ä»…ä¾›æ‰‹åŠ¨è¿ç§»æ—¶ä½¿ç”¨ã€‚

#### `database/migration_add_composite_unique.sql`
- SQL è¿ç§»è„šæœ¬
- é€‚ç”¨äºæ‰‹åŠ¨æ‰§è¡Œæ•°æ®åº“è¿ç§»

#### `migration/migrate_client_traffics.go`
- Go è¿ç§»è„šæœ¬
- è‡ªåŠ¨å¤‡ä»½ã€è¿ç§»å’Œæ¢å¤æ•°æ®
- åŒ…å«é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶

#### `migration/README.md`
- è¯¦ç»†çš„è¿ç§»æŒ‡å—
- åŒ…å«è¿ç§»æ­¥éª¤ã€éªŒè¯æ–¹æ³•å’Œå›æ»šè¯´æ˜

#### `migration/TESTING.md`
- æµ‹è¯•æŒ‡å—
- åŒ…å«æµ‹è¯•åœºæ™¯å’ŒéªŒè¯æ­¥éª¤

## æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“å˜æ›´

**æ—§ç»“æ„ï¼š**
```sql
CREATE TABLE client_traffics (
    id INTEGER PRIMARY KEY,
    inbound_id INTEGER,
    email TEXT UNIQUE,  -- å…¨å±€å”¯ä¸€
    ...
);
```

**æ–°ç»“æ„ï¼š**
```sql
CREATE TABLE client_traffics (
    id INTEGER PRIMARY KEY,
    inbound_id INTEGER,
    email TEXT,
    ...,
    UNIQUE(inbound_id, email)  -- è”åˆå”¯ä¸€
);

CREATE INDEX idx_inbound_email ON client_traffics(inbound_id, email);
```

### å½±å“èŒƒå›´

**å—å½±å“çš„åŠŸèƒ½ï¼š**
1. âœ… V2Board åŒæ­¥ - å¯ä»¥å°†åŒä¸€ä¸ªç”¨æˆ·åŒæ­¥åˆ°å¤šä¸ªèŠ‚ç‚¹
2. âœ… å®¢æˆ·ç«¯ç®¡ç† - æ¯ä¸ª inbound ç‹¬ç«‹ç®¡ç†å®¢æˆ·ç«¯
3. âœ… æµé‡ç»Ÿè®¡ - åˆ†åˆ«è®°å½•å„ inbound çš„æµé‡
4. âœ… å®¢æˆ·ç«¯æŸ¥è¯¢ - éœ€è¦åŒæ—¶ä½¿ç”¨ inbound_id å’Œ email

**ä¸å—å½±å“çš„åŠŸèƒ½ï¼š**
1. âœ… Inbound é…ç½®
2. âœ… Xray æ ¸å¿ƒè¿è¡Œ
3. âœ… è®¢é˜…åŠŸèƒ½
4. âœ… å…¶ä»–è¡¨çš„æ•°æ®

### å…¼å®¹æ€§

- **å‘åå…¼å®¹ï¼š** æ˜¯ï¼ˆåªè¦æ‰§è¡Œè¿ç§»ï¼‰
- **éœ€è¦é‡å¯ï¼š** æ˜¯
- **æ•°æ®ä¸¢å¤±é£é™©ï¼š** ä½ï¼ˆåŒ…å«å¤‡ä»½æœºåˆ¶ï¼‰

## ä½¿ç”¨æ–¹æ³•

### ğŸ‰ æ¨èæ–¹å¼ï¼šè‡ªåŠ¨å‡çº§

**æœ€ç®€å•çš„æ–¹å¼ï¼** æ•°æ®åº“è¿ç§»å·²é›†æˆåˆ°å¯åŠ¨æµç¨‹ä¸­ã€‚

1. æ‹‰å–æœ€æ–°ä»£ç 
2. é‡æ–°ç¼–è¯‘
3. é‡å¯æœåŠ¡ â†’ **è‡ªåŠ¨å®Œæˆè¿ç§»ï¼**

è¯¦ç»†æ­¥éª¤ï¼š
```bash
# 1. å¤‡ä»½æ•°æ®åº“ï¼ˆå»ºè®®ï¼‰
sudo cp /etc/x-ui/x-ui.db /etc/x-ui/x-ui.db.backup

# 2. åœæ­¢æœåŠ¡
sudo x-ui stop

# 3. æ›´æ–°ä»£ç 
cd /path/to/X-Panel
git pull

# 4. é‡æ–°ç¼–è¯‘
go build -o x-ui main.go
sudo mv x-ui /usr/local/x-ui/

# 5. å¯åŠ¨æœåŠ¡ï¼ˆè‡ªåŠ¨è¿ç§»ï¼‰
sudo x-ui start

# 6. æ£€æŸ¥æ—¥å¿—ç¡®è®¤è¿ç§»æˆåŠŸ
sudo x-ui log | grep -i "client_traffics"
```

### å¤‡é€‰æ–¹å¼ï¼šæ‰‹åŠ¨è¿ç§»

å¦‚æœéœ€è¦æ‰‹åŠ¨æ§åˆ¶è¿ç§»è¿‡ç¨‹ï¼š

**å¯¹äºå¼€å‘è€…ï¼š**
1. æ‹‰å–æœ€æ–°ä»£ç 
2. æ‰§è¡Œè¿ç§»è„šæœ¬ï¼ˆå¯é€‰ï¼‰
3. é‡æ–°ç¼–è¯‘å’Œéƒ¨ç½²

**å¯¹äºç”¨æˆ·ï¼š**

1. åœæ­¢ X-Panel æœåŠ¡
2. å¤‡ä»½æ•°æ®åº“
3. æ‰§è¡Œè¿ç§»è„šæœ¬
4. æ›´æ–°åˆ°æ–°ç‰ˆæœ¬
5. é‡å¯æœåŠ¡

## éªŒè¯æ¸…å•

- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸ
- [ ] ç´¢å¼•æ­£ç¡®åˆ›å»ºï¼ˆ`idx_inbound_email`ï¼‰
- [ ] åŸæœ‰å®¢æˆ·ç«¯æ•°æ®å®Œæ•´
- [ ] å¯ä»¥åœ¨å¤šä¸ª inbound ä¸­æ·»åŠ åŒä¸€ä¸ª email
- [ ] V2Board åŒæ­¥ä¸å†æŠ¥ "Duplicate email" é”™è¯¯
- [ ] æµé‡ç»Ÿè®¡æ­£å¸¸å·¥ä½œ
- [ ] å®¢æˆ·ç«¯å¯ç”¨/ç¦ç”¨æ­£å¸¸
- [ ] è®¢é˜…é“¾æ¥æ­£å¸¸ç”Ÿæˆ

## å›æ»šè®¡åˆ’

å¦‚æœå‡ºç°é—®é¢˜ï¼š

1. **ç«‹å³å›æ»šï¼š**
   ```bash
   x-ui stop
   cp /etc/x-ui/x-ui.db.backup /etc/x-ui/x-ui.db
   x-ui start
   ```

2. **æ¢å¤æ—§ç‰ˆæœ¬ä»£ç ï¼š**
   ```bash
   git checkout <previous-commit>
   go build
   ```

## æ³¨æ„äº‹é¡¹

1. **å¿…é¡»æ‰§è¡Œæ•°æ®åº“è¿ç§»** - å¦åˆ™ä¼šå‡ºç°è¿è¡Œæ—¶é”™è¯¯
2. **å…ˆå¤‡ä»½æ•°æ®åº“** - è™½ç„¶æœ‰è‡ªåŠ¨å¤‡ä»½ï¼Œä½†å»ºè®®æ‰‹åŠ¨å¤‡ä»½
3. **åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯** - ç¡®ä¿è¿ç§»æˆåŠŸ
4. **æ³¨æ„ç°æœ‰é‡å¤æ•°æ®** - å¦‚æœå·²æœ‰é‡å¤ emailï¼Œè¿ç§»ä¼šä¿ç•™ç¬¬ä¸€æ¡

## æ€§èƒ½å½±å“

- **æŸ¥è¯¢æ€§èƒ½ï¼š** åŸºæœ¬æ— å½±å“ï¼ˆä»ä½¿ç”¨ç´¢å¼•ï¼‰
- **æ’å…¥æ€§èƒ½ï¼š** åŸºæœ¬æ— å½±å“
- **å­˜å‚¨ç©ºé—´ï¼š** æ— å˜åŒ–

## æœªæ¥è®¡åˆ’

å¯èƒ½çš„æ”¹è¿›ï¼š
1. æ”¯æŒ `InboundClientIps` è¡¨çš„è”åˆå”¯ä¸€çº¦æŸ
2. æ·»åŠ  Web UI æ˜¾ç¤ºåŒä¸€ç”¨æˆ·åœ¨ä¸åŒ inbound çš„ç»Ÿè®¡
3. æ”¯æŒæ‰¹é‡è¿ç§»ç”¨æˆ·åˆ°ä¸åŒ inbound

## ç›¸å…³ Issue

- ä¿®å¤ï¼šV2Board åŒæ­¥æ—¶ "Duplicate email" é”™è¯¯
- æ”¯æŒï¼šåŒä¸€ç”¨æˆ·åœ¨å¤šä¸ªèŠ‚ç‚¹ï¼ˆinboundï¼‰ä¸­å­˜åœ¨
